<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Update</title>
        <link rel="stylesheet" href="../style/update.css" />
        <link rel="icon" type="image/x-icon" href="../assets/img/football.png" />
        <link href="https://cdn.jsdelivr.net/npm/remixicon@3.2.0/fonts/remixicon.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    </head>
    <body>
        <div class="container">
            <div class="row gutters">
                <div class="col-xl-3 col-lg-3 col-md-12 col-sm-12 col-12">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="account-settings">
                                <div class="user-profile">
                                    <!-- <div class="user-avatar">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="Maxwell Admin" />
                                    </div> -->
                                    <div className="personal-image">
                                        <label className="label">
                                            <input type="file" class="d-none" id="image-choose" accept="image/*" />
                                            <figure className="personal-figure">
                                                <img
                                                    src="../assets/img/avatar_info.jpg"
                                                    class="personal-avatar"
                                                    alt="avatar"
                                                    id="image"
                                                />
                                                <!-- <figcaption className="personal-figcaption">
                                                    <img
                                                        src="https://raw.githubusercontent.com/ThiagoLuizNunes/angular-boilerplate/master/src/assets/imgs/camera-white.png"
                                                    />
                                                </figcaption> -->
                                            </figure>
                                        </label>
                                    </div>
                                    <h6 class="user-email" id="email-des">yuki@Maxwell.com</h6>
                                </div>
                                <div class="d-flex justify-content-center">
                                    <!-- <button class="btn btn-outline-primary btn-sm me-1">Thay đổi</button> -->
                                    <button class="btn btn-outline-secondary btn-sm" id="delete-image">Xóa ảnh</button>
                                </div>
                                <!-- <div class="about">
                                    <h5>About</h5>
                                    <p>
                                        I'm Yuki. Full Stack Designer I enjoy creating user-centric, delightful and
                                        human experiences.
                                    </p>
                                </div> -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-9 col-lg-9 col-md-12 col-sm-12 col-12">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="row gutters">
                                <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                                    <h6 class="mb-2 text-primary">Thông tin cá nhân</h6>
                                </div>
                                <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                    <div class="form-group">
                                        <label for="fullName">Họ tên</label>
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="fullName"
                                            placeholder="Enter full name"
                                        />
                                    </div>
                                </div>
                                <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                    <div class="form-group">
                                        <label for="email">Email</label>
                                        <input
                                            type="email"
                                            class="form-control"
                                            id="email"
                                            disabled
                                            placeholder="vantung@gmail.com"
                                        />
                                    </div>
                                </div>
                                <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                    <div class="form-group">
                                        <label for="phone">Số điện thoại</label>
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="phone"
                                            placeholder="Enter phone number"
                                        />
                                    </div>
                                </div>
                                <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                    <div class="form-group">
                                        <label for="dob">Ngày sinh</label>
                                        <input type="date" class="form-control" id="dob" />
                                    </div>
                                </div>
                            </div>
                            <div class="row gutters">
                                <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                                    <h6 class="mt-3 mb-2 text-primary">Thông tin địa chỉ</h6>
                                </div>

                                <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                    <div class="form-group">
                                        <label for="Street">Địa chỉ</label>
                                        <input
                                            type="name"
                                            class="form-control"
                                            id="Street"
                                            placeholder="Enter Street"
                                        />
                                    </div>
                                </div>
                                <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                    <div class="form-group">
                                        <label for="list-city">Tỉnh/Thành phố</label>
                                        <select class="form-select" id="list-city">
                                            <option value="">-- Tỉnh/Thành phố --</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                    <div class="form-group">
                                        <label for="list-district">Quận/huyện</label>
                                        <select class="form-select" id="list-district">
                                            <option value="">-- Quận/huyện --</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
                                    <div class="form-group">
                                        <label for="list-ward">Xã/phường</label>
                                        <select class="form-select" id="list-ward">
                                            <option value="">-- Xã/phường --</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row gutters">
                                <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                                    <div class="text-right">
                                        <button
                                            type="button"
                                            id="back"
                                            name="submit"
                                            class="btn btn-secondary mt-3 me-2"
                                        >
                                            Quay lại
                                        </button>
                                        <button type="button" id="save-btn" name="submit" class="btn btn-primary mt-3">
                                            Lưu
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
        <script src="../js/main.js"></script>
        <script>
            const imageChoose = document.getElementById("image-choose");
            const image = document.getElementById("image");
            const emailDes = document.getElementById("email-des");
            const fullName = document.getElementById("fullName");
            const email = document.getElementById("email");
            const phoneNumber = document.getElementById("phone");
            const dob = document.getElementById("dob");
            const listCity = document.getElementById("list-city");
            const listDistrict = document.getElementById("list-district");
            const listWard = document.getElementById("list-ward");
            const street = document.getElementById("Street");
            const saveBtn = document.getElementById("save-btn");
            const deleteImage = document.getElementById("delete-image");
            const backBtn = document.getElementById("back");

            const userId = localStorage.getItem("userId");

            if (!userId) {
                location.href = "../login.html";
            }

            // call api tỉnh thành phố
            function callAPIProvince(provinceSelected = null) {
                $.ajax({
                    url: `${url_api}/province`,
                    type: "get",
                    success(res) {
                        console.log(res);
                        if (res.status == "success") {
                            //call function setDataProvince
                            setDataProvince(res.data, provinceSelected);
                        }
                    },
                    error: console.log,
                });
            }

            // đổ dữ liệu tỉnh/ thành vào tag select
            function setDataProvince(data, provinceSelected = null) {
                const listProvinceHtml =
                    `<option value="">-- Tỉnh/thành phố --</option>` +
                    data
                        .map(function (item) {
                            if (item.id == provinceSelected) {
                                return `<option value="${item.id}" selected>${item.name}</option>`;
                            } else {
                                return `<option value="${item.id}">${item.name}</option>`;
                            }
                        })
                        .join("");
                listCity.innerHTML = listProvinceHtml;
            }

            listCity.addEventListener("change", function () {
                setDataWard();
                if (listCity.value) {
                    callAPIDistrict(listCity.value);
                } else {
                    setDataDistrict();
                }
            });

            //call api district
            function callAPIDistrict(provinceId, districtSelected = null) {
                $.ajax({
                    url: `${url_api}/district`,
                    type: "get",
                    data: {
                        province_id: provinceId,
                    },
                    success(res) {
                        console.log(res);
                        if (res.status == "success") {
                            setDataDistrict(res.data, districtSelected);
                        }
                    },
                    error: console.log,
                });
            }

            // function setDataDistrict
            function setDataDistrict(data = [], districtSelected = null) {
                const listDistrictHtml =
                    `<option value="">-- Quận/huyện --</option>` +
                    data
                        .map(function (item) {
                            if (item.id == districtSelected) {
                                return `<option value="${item.id}" selected>${item.name}</option>`;
                            } else {
                                return `<option value="${item.id}">${item.name}</option>`;
                            }
                        })
                        .join("");
                listDistrict.innerHTML = listDistrictHtml;
            }

            listDistrict.addEventListener("change", function () {
                if (listDistrict.value) {
                    callAPIWard(listDistrict.value);
                } else {
                    setDataWard();
                }
            });

            //call api ward
            function callAPIWard(districtId, wardSelected = null) {
                $.ajax({
                    url: `${url_api}/ward`,
                    type: "get",
                    data: {
                        district_id: districtId,
                    },
                    success(res) {
                        console.log(res);
                        if (res.status == "success") {
                            setDataWard(res.data, wardSelected);
                        }
                    },
                    error: console.log,
                });
            }

            function setDataWard(data = [], wardSelected = null) {
                const listWardHtml =
                    `<option value="">-- Xã/phường --</option>` +
                    data
                        .map(function (item) {
                            if (item.id == wardSelected) {
                                return `<option value="${item.id}" selected>${item.name}</option>`;
                            } else {
                                return `<option value="${item.id}">${item.name}</option>`;
                            }
                        })
                        .join("");
                listWard.innerHTML = listWardHtml;
            }

            // call api customer
            $.ajax({
                url: `${url_api}/customer/by-id`,
                type: "get",
                data: {
                    customer_id: userId,
                },
                success(res) {
                    console.log(res);
                    setDataCustomer(res.data);
                },
                error: console.log,
            });

            function setDataCustomer(data) {
                emailDes.textContent = data.email;
                fullName.value = data.name;
                email.value = data.email;
                phoneNumber.value = data.phone_number;
                dob.value = data.dob;
                street.value = data.address;
                image.src = data.image ? data.image : "../assets/img/avatar_info.jpg";

                callAPIProvince(data.ward.district.province.id);
                callAPIDistrict(data.ward.district.province.id, data.ward.district.id);
                callAPIWard(data.ward.district.id, data.ward.id);

                imageChoose.addEventListener("change", function (e) {
                    var selectedFile = event.target.files[0];
                    var reader = new FileReader();

                    reader.onload = function (event) {
                        var imageUrl = event.target.result;
                        image.src = imageUrl;
                    };

                    reader.readAsDataURL(selectedFile);
                });

                deleteImage.addEventListener("click", function () {
                    image.src = "../assets/img/avatar_info.jpg";
                    imageChoose.value = null;
                });

                saveBtn.addEventListener("click", function () {
                    if (confirm("Bạn chắc chắn muốn thay đổi thông tin của mình không?")) {
                        let formData = new FormData();
                        formData.append("customer_id", userId);
                        formData.append("name", fullName.value);
                        formData.append("image", imageChoose.files[0]);
                        formData.append("dob", dob.value);
                        formData.append("phone_number", phoneNumber.value);
                        formData.append("ward_id", listWard.value);
                        formData.append("address", street.value);
                        formData.append("status_id", 2);

                        $.ajax({
                            url: `${url_api}/customer/update`,
                            type: "post",
                            data: formData,
                            contentType: false,
                            cache: false,
                            processData: false,
                            success(res) {
                                console.clear();
                                console.log(res);
                                if (res.status == "success") {
                                    alert("Cập nhật thông tin thành công");
                                    location.reload();
                                }
                            },
                            error: console.log,
                        });
                    }
                });
            }

            backBtn.addEventListener("click", function() {
                location.href = "index.html";
            });
        </script>
    </body>
</html>
